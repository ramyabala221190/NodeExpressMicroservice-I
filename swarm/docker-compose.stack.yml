services:
    cart-node:
       deploy:
        replicas: 3
        restart_policy:
          condition: on-failure
        placement:
          constraints: [node.labels.role == worker1]
       volumes:
       - logs-volume:/var/log/${APPNAME}
       env_file: 
        - ../docker/environments/common.env
       image: ${DOCKERHUB_USER}/${APPNAME}:${TAG}
    

    cart-db:
      deploy:
        restart_policy:
          condition: on-failure
        placement:
          constraints: [node.labels.role == worker1]
      image: mongo:latest
      volumes:
         - mongo-data:/data/db

    filebeat:
      image: ${DOCKERHUB_USER}/${APPNAME}-filebeat:${TAG}
      deploy:
        restart_policy:
          condition: on-failure
        placement:
          constraints: [node.labels.role == worker1]
      environment:
         - strict.perms=false
         - APPNAME=${APPNAME}
      volumes:
         - logs-volume:/var/log/${APPNAME}/:ro

networks:
   shared-swarm-net-dev:
      external: true
   shared-swarm-net-prod:
      external: true
  

volumes:
  mongo-data:
  logs-volume:

  # In this example, mongo-data is a named volume that ensures all data written 
  # by the MongoDB container to /data/db (MongoDB's default data directory) is saved persistently 
  # on the host system, even if the mongodb container is removed or recreated.